<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nurani - Tracker Amalan Harian</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #f8fafc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        /* Animasi */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONS COMPONENTS (Ganti Lucide-React) ---
        // Kita buat komponen manual sebab tak boleh import library dalam HTML biasa
        const Icon = ({ path, className, size = 24, fill="none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />,
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>} />,
            Trash2: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />,
            BarChart2: (p) => <Icon {...p} path={<><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></>} />,
            X: (p) => <Icon {...p} path={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />,
            RefreshCcw: (p) => <Icon {...p} path={<><polyline points="1 4 1 10 7 10"/><polyline points="23 20 23 14 17 14"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></>} />,
            Sparkles: (p) => <Icon {...p} path={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275Z"/></>} />,
            BookOpen: (p) => <Icon {...p} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />,
            Shield: (p) => <Icon {...p} path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></>} />,
            Heart: (p) => <Icon {...p} path={<><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></>} />,
            Sun: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></>} />,
            Moon: (p) => <Icon {...p} path={<><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></>} />,
        };

        // --- MAIN APP COMPONENT ---
        function NuraniTracker() {
            // !!! PENTING: Masukkan API Key Google Gemini anda di sini jika mahu AI berfungsi !!!
            const apiKey = ""; 
            
            const defaultAmalan = [
                { id: 'def1', title: "100x Alam Nasyrah", target: 100, count: 0, icon: 'book' },
                { id: 'def2', title: "100x Al-Ikhlas", target: 100, count: 0, icon: 'shield' },
                { id: 'def3', title: "100x Selawat", target: 100, count: 0, icon: 'heart' },
                { id: 'def4', title: "100x Istighfar", target: 100, count: 0, icon: 'refresh' },
                { id: 'def5', title: "Solat Dhuha", target: 1, count: 0, icon: 'sun' },
                { id: 'def6', title: "Solat Witir", target: 1, count: 0, icon: 'moon' },
            ];

            const [tasks, setTasks] = useState(defaultAmalan);
            const [history, setHistory] = useState([]);
            const [view, setView] = useState('home'); 
            const [activeTasbih, setActiveTasbih] = useState(null); 
            const [showAddModal, setShowAddModal] = useState(false);
            const [newTaskName, setNewTaskName] = useState("");
            const [newTaskTarget, setNewTaskTarget] = useState(100);
            const [aiMotivation, setAiMotivation] = useState("");
            const [isAiLoading, setIsAiLoading] = useState(false);

            // Init
            useEffect(() => {
                const savedTasks = localStorage.getItem('nurani_tasks');
                const savedHistory = localStorage.getItem('nurani_history');
                const savedDate = localStorage.getItem('nurani_lastDate');
                const today = new Date().toDateString();

                if (savedHistory) setHistory(JSON.parse(savedHistory));

                if (savedDate !== today) {
                    // Reset Logic
                    if (savedTasks && savedDate) {
                        const prevTasks = JSON.parse(savedTasks);
                        const completionRate = prevTasks.reduce((acc, t) => acc + (t.count >= t.target ? 1 : 0), 0) / prevTasks.length;
                        const newHistoryLog = { date: savedDate, rate: completionRate };
                        const updatedHistory = [newHistoryLog, ...(savedHistory ? JSON.parse(savedHistory) : [])].slice(0, 30);
                        setHistory(updatedHistory);
                        localStorage.setItem('nurani_history', JSON.stringify(updatedHistory));
                    }
                    const tasksToReset = savedTasks ? JSON.parse(savedTasks) : defaultAmalan;
                    const resetTasks = tasksToReset.map(t => ({ ...t, count: 0 }));
                    setTasks(resetTasks);
                    localStorage.setItem('nurani_lastDate', today);
                } else {
                    if (savedTasks) setTasks(JSON.parse(savedTasks));
                }

                if (!sessionStorage.getItem('daily_advice_generated')) {
                    generateAiAdvice(savedTasks ? JSON.parse(savedTasks) : defaultAmalan);
                    sessionStorage.setItem('daily_advice_generated', 'true');
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('nurani_tasks', JSON.stringify(tasks));
            }, [tasks]);

            const handleTaskClick = (task) => {
                if (task.target > 1) { setActiveTasbih(task); } 
                else { updateTaskCount(task.id, task.count === 0 ? 1 : 0); }
            };

            const updateTaskCount = (id, newCount) => {
                setTasks(prev => prev.map(t => {
                    if (t.id === id) {
                        const cappedCount = Math.min(Math.max(0, newCount), t.target);
                        return { ...t, count: cappedCount };
                    }
                    return t;
                }));
            };

            const handleTasbihTap = () => {
                if (!activeTasbih) return;
                if (navigator.vibrate) navigator.vibrate(10);
                const currentTask = tasks.find(t => t.id === activeTasbih.id);
                if (currentTask.count < currentTask.target) {
                    updateTaskCount(activeTasbih.id, currentTask.count + 1);
                } else {
                    setActiveTasbih(null);
                }
            };

            const addNewTask = () => {
                if (!newTaskName.trim()) return;
                const newTask = {
                    id: Date.now().toString(),
                    title: newTaskName,
                    target: parseInt(newTaskTarget) || 1,
                    count: 0,
                    icon: 'sparkles'
                };
                setTasks([...tasks, newTask]);
                setNewTaskName(""); setNewTaskTarget(100); setShowAddModal(false);
            };

            const deleteTask = (id) => {
                if (confirm("Padam amalan ini?")) {
                    setTasks(tasks.filter(t => t.id !== id));
                }
            };

            const generateAiAdvice = async (currentTasks) => {
                if (!apiKey) {
                    setAiMotivation("Sila masukkan API Key untuk guna fungsi AI.");
                    return;
                }
                setIsAiLoading(true);
                const completed = currentTasks.filter(t => t.count >= t.target).length;
                const prompt = `User tracking Islamic daily amalan. Progress: ${completed}/${currentTasks.length}. Give short Malay Islamic motivation about Istiqomah. Max 2 sentences.`;

                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        }
                    );
                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) setAiMotivation(text);
                } catch (e) {
                    setAiMotivation("Istiqomah itu berat, kerana ganjarannya syurga.");
                } finally {
                    setIsAiLoading(false);
                }
            };

            const getIcon = (name, className) => {
                const map = {
                    book: Icons.BookOpen, shield: Icons.Shield, heart: Icons.Heart,
                    refresh: Icons.RefreshCcw, sun: Icons.Sun, moon: Icons.Moon, sparkles: Icons.Sparkles
                };
                const IconComp = map[name] || Icons.Sparkles;
                return <IconComp className={className} />;
            };

            // RENDER LOGIC
            const completedCount = tasks.filter(t => t.count >= t.target).length;
            const overallProgress = tasks.length > 0 ? (completedCount / tasks.length) * 100 : 0;

            if (activeTasbih) {
                const task = tasks.find(t => t.id === activeTasbih.id);
                const progress = (task.count / task.target) * 100;
                return (
                    <div className="fixed inset-0 bg-emerald-900 z-50 flex flex-col items-center justify-between py-12 px-6 text-white" onClick={handleTasbihTap}>
                        <button onClick={(e) => { e.stopPropagation(); setActiveTasbih(null); }} className="absolute top-6 right-6 p-2 bg-emerald-800 rounded-full"><Icons.X size={24} /></button>
                        <div className="text-center mt-10"><h2 className="opacity-80">Sedang Berzikir</h2><h1 className="text-3xl font-bold mt-2">{task.title}</h1></div>
                        <div className="text-8xl font-bold font-mono">{task.count}</div>
                        <div className="text-center opacity-70 mb-10"><p>Tap skrin untuk kira</p><p>Target: {task.target}</p></div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-24 max-w-md mx-auto bg-slate-50 shadow-2xl relative">
                    {/* Header */}
                    <div className="bg-emerald-600 text-white p-6 pb-12 rounded-b-[2.5rem] relative overflow-hidden">
                        <div className="flex justify-between items-start mb-4">
                            <div><h1 className="text-2xl font-bold">Nurani</h1><p className="text-emerald-100 text-sm">{new Date().toLocaleDateString('ms-MY', { weekday: 'long', day: 'numeric', month: 'long' })}</p></div>
                            <button onClick={() => setView(view === 'stats' ? 'home' : 'stats')} className="p-2 bg-emerald-500 rounded-xl">{view === 'stats' ? <Icons.X size={20}/> : <Icons.BarChart2 size={20} />}</button>
                        </div>
                        <div className="bg-emerald-700/50 p-4 rounded-2xl flex items-center gap-4 border border-emerald-500/30">
                            <div className="text-2xl font-bold">{Math.round(overallProgress)}%</div>
                            <div><p className="text-sm font-medium">Pencapaian Hari Ini</p><p className="text-xs opacity-70">{completedCount} / {tasks.length} Selesai</p></div>
                        </div>
                    </div>

                    {/* AI Box */}
                    <div className="px-6 -mt-6 mb-4">
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-emerald-100 flex gap-3 items-start">
                            <Icons.Sparkles className="text-yellow-500 mt-1 flex-shrink-0" size={18} />
                            <div className="flex-1">
                                <p className="text-xs font-bold text-slate-400 uppercase mb-1">Pesanan Nurani</p>
                                <p className="text-sm text-slate-700 italic">{isAiLoading ? "..." : (aiMotivation || "Mulakan dengan Bismillah.")}</p>
                            </div>
                            <button onClick={() => generateAiAdvice(tasks)} className="text-slate-300"><Icons.RefreshCcw size={14}/></button>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="px-5 space-y-4">
                        {view === 'stats' ? (
                            <div className="animate-in">
                                <h2 className="font-bold text-lg mb-4">Analisis Istiqomah</h2>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border h-48 flex items-end justify-between gap-2">
                                    {history.length === 0 && <span className="text-xs text-slate-400 mx-auto">Tiada data lagi</span>}
                                    {[...history].reverse().slice(-7).map((log, i) => (
                                        <div key={i} className="flex-1 bg-emerald-200 rounded-t-md relative group" style={{height: `${Math.max(10, log.rate * 100)}%`}}>
                                            <div className="opacity-0 group-hover:opacity-100 absolute -top-8 left-1/2 -translate-x-1/2 bg-black text-white text-xs p-1 rounded">{Math.round(log.rate*100)}%</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {tasks.map(task => {
                                    const isDone = task.count >= task.target;
                                    return (
                                        <div key={task.id} onClick={() => handleTaskClick(task)} className={`bg-white p-4 rounded-2xl border flex items-center justify-between cursor-pointer active:scale-95 transition ${isDone ? 'border-emerald-500 bg-emerald-50' : 'border-slate-100'}`}>
                                            <div className="flex items-center gap-4">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center ${isDone ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-400'}`}>{getIcon(task.icon, "w-5 h-5")}</div>
                                                <div><h3 className={`font-semibold ${isDone ? 'text-emerald-800' : 'text-slate-700'}`}>{task.title}</h3><p className="text-xs text-slate-400">{task.target > 1 ? `Target: ${task.target}` : 'Harian'}</p></div>
                                            </div>
                                            {task.target > 1 ? <span className={`font-mono font-bold ${isDone?'text-emerald-600':'text-slate-500'}`}>{task.count}/{task.target}</span> : <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${isDone ? 'bg-emerald-500 border-emerald-500' : 'border-slate-300'}`}>{isDone && <Icons.CheckCircle size={14} className="text-white"/>}</div>}
                                            <button onClick={(e)=>{e.stopPropagation(); deleteTask(task.id)}} className="text-slate-300 hover:text-red-500 px-2"><Icons.Trash2 size={16}/></button>
                                        </div>
                                    )
                                })}
                            </div>
                        )}
                    </div>

                    {/* Add Button */}
                    <button onClick={() => setShowAddModal(true)} className="fixed bottom-6 right-6 w-14 h-14 bg-emerald-600 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-emerald-700 active:scale-90 transition"><Icons.Plus size={28}/></button>

                    {/* Modal */}
                    {showAddModal && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-in">
                                <h3 className="font-bold text-lg mb-4">Tambah Amalan</h3>
                                <input placeholder="Nama Amalan" className="w-full p-3 bg-slate-50 border rounded-xl mb-3" value={newTaskName} onChange={e=>setNewTaskName(e.target.value)} />
                                <input type="number" placeholder="Target (100)" className="w-full p-3 bg-slate-50 border rounded-xl mb-4" value={newTaskTarget} onChange={e=>setNewTaskTarget(e.target.value)} />
                                <div className="flex gap-2">
                                    <button onClick={()=>setShowAddModal(false)} className="flex-1 py-3 bg-slate-100 rounded-xl">Batal</button>
                                    <button onClick={addNewTask} className="flex-1 py-3 bg-emerald-600 text-white rounded-xl">Simpan</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<NuraniTracker />);
    </script>
</body>
</html>

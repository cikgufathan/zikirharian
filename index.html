import React, { useState, useEffect, useRef } from 'react';
import { 
  CheckCircle, Plus, Trash2, BarChart2, Calendar, 
  Sparkles, X, ChevronRight, RefreshCcw, Heart, Shield,
  BookOpen, Sun, Moon
} from 'lucide-react';

export default function NuraniTracker() {
  const apiKey = ""; // API Key injected automatically
  
  // --- DEFAULT DATA ---
  const defaultAmalan = [
    { id: 'def1', title: "100x Alam Nasyrah", target: 100, count: 0, icon: 'book' },
    { id: 'def2', title: "100x Al-Ikhlas", target: 100, count: 0, icon: 'shield' },
    { id: 'def3', title: "100x Selawat", target: 100, count: 0, icon: 'heart' },
    { id: 'def4', title: "100x Istighfar", target: 100, count: 0, icon: 'refresh' },
    { id: 'def5', title: "Solat Dhuha", target: 1, count: 0, icon: 'sun' },
    { id: 'def6', title: "Solat Witir", target: 1, count: 0, icon: 'moon' },
  ];

  // --- STATES ---
  const [tasks, setTasks] = useState(defaultAmalan);
  const [history, setHistory] = useState([]);
  const [lastDate, setLastDate] = useState(new Date().toDateString());
  
  // UI States
  const [view, setView] = useState('home'); // home, stats, add
  const [activeTasbih, setActiveTasbih] = useState(null); // ID task yang sedang dikira
  const [showAddModal, setShowAddModal] = useState(false);
  const [newTaskName, setNewTaskName] = useState("");
  const [newTaskTarget, setNewTaskTarget] = useState(100);
  
  // AI States
  const [aiMotivation, setAiMotivation] = useState("");
  const [isAiLoading, setIsAiLoading] = useState(false);

  // --- INITIALIZATION & PERSISTENCE ---
  useEffect(() => {
    const savedTasks = localStorage.getItem('nurani_tasks');
    const savedHistory = localStorage.getItem('nurani_history');
    const savedDate = localStorage.getItem('nurani_lastDate');
    const today = new Date().toDateString();

    if (savedHistory) setHistory(JSON.parse(savedHistory));

    // Logic: Reset jika hari baru
    if (savedDate !== today) {
      // Archive semalam punya progress jika ada
      if (savedTasks && savedDate) {
        const prevTasks = JSON.parse(savedTasks);
        const completionRate = prevTasks.reduce((acc, t) => acc + (t.count >= t.target ? 1 : 0), 0) / prevTasks.length;
        
        // Simpan ke history
        const newHistoryLog = { date: savedDate, rate: completionRate, tasks: prevTasks };
        const updatedHistory = [newHistoryLog, ...(savedHistory ? JSON.parse(savedHistory) : [])].slice(0, 30); // Simpan 30 hari
        setHistory(updatedHistory);
        localStorage.setItem('nurani_history', JSON.stringify(updatedHistory));
      }
      
      // Reset tasks count to 0 but keep structure
      const tasksToReset = savedTasks ? JSON.parse(savedTasks) : defaultAmalan;
      const resetTasks = tasksToReset.map(t => ({ ...t, count: 0 }));
      setTasks(resetTasks);
      setLastDate(today);
      localStorage.setItem('nurani_lastDate', today);
    } else {
      // Hari yang sama, load macam biasa
      if (savedTasks) setTasks(JSON.parse(savedTasks));
    }
    
    // Auto generate AI motivation on first load
    if (!sessionStorage.getItem('daily_advice_generated')) {
      generateAiAdvice(savedTasks ? JSON.parse(savedTasks) : defaultAmalan);
      sessionStorage.setItem('daily_advice_generated', 'true');
    }
  }, []);

  useEffect(() => {
    localStorage.setItem('nurani_tasks', JSON.stringify(tasks));
  }, [tasks]);

  // --- FUNCTIONS ---

  const handleTaskClick = (task) => {
    if (task.target > 1) {
      // Buka Tasbih Mode
      setActiveTasbih(task);
    } else {
      // Toggle Checkbox (untuk solat dll)
      updateTaskCount(task.id, task.count === 0 ? 1 : 0);
    }
  };

  const updateTaskCount = (id, newCount) => {
    setTasks(prev => prev.map(t => {
      if (t.id === id) {
        const cappedCount = Math.min(Math.max(0, newCount), t.target); // Limit 0 to target
        return { ...t, count: cappedCount };
      }
      return t;
    }));
  };

  const handleTasbihTap = () => {
    if (!activeTasbih) return;
    
    // Haptic Feedback
    if (navigator.vibrate) navigator.vibrate(10);
    
    const currentTask = tasks.find(t => t.id === activeTasbih.id);
    if (currentTask.count < currentTask.target) {
      updateTaskCount(activeTasbih.id, currentTask.count + 1);
    } else {
      // Dah siap, tutup tasbih
      setActiveTasbih(null);
    }
  };

  const addNewTask = () => {
    if (!newTaskName.trim()) return;
    const newTask = {
      id: Date.now().toString(),
      title: newTaskName,
      target: parseInt(newTaskTarget) || 1,
      count: 0,
      icon: 'sparkles'
    };
    setTasks([...tasks, newTask]);
    setNewTaskName("");
    setNewTaskTarget(100);
    setShowAddModal(false);
  };

  const deleteTask = (id) => {
    if (confirm("Adakah anda pasti ingin memadam amalan ini?")) {
      setTasks(tasks.filter(t => t.id !== id));
    }
  };

  // --- AI FUNCTION ---
  const generateAiAdvice = async (currentTasks) => {
    setIsAiLoading(true);
    const completed = currentTasks.filter(t => t.count >= t.target).length;
    const total = currentTasks.length;
    const percent = Math.round((completed/total)*100);
    
    const prompt = `User is tracking Islamic daily amalan. Today progress: ${completed}/${total} tasks completed (${percent}%). 
    Tasks: ${currentTasks.map(t => t.title).join(', ')}.
    Give a short, gentle, and heart-touching Islamic motivation (in Malay) about Istiqomah. 
    If progress is low, encourage them softly. If high, remind them of gratitude/humility.
    Max 2 sentences. Use emojis.`;

    try {
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        }
      );
      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
      if (text) setAiMotivation(text);
    } catch (e) {
      console.error(e);
      setAiMotivation("Istiqomah itu berat, kerana ganjarannya syurga. Teruskan usaha! ðŸ¤²");
    } finally {
      setIsAiLoading(false);
    }
  };

  // --- ICONS HELPER ---
  const getIcon = (iconName, className) => {
    const icons = {
      book: <BookOpen className={className} />,
      shield: <Shield className={className} />,
      heart: <Heart className={className} />,
      refresh: <RefreshCcw className={className} />,
      sun: <Sun className={className} />,
      moon: <Moon className={className} />,
      sparkles: <Sparkles className={className} />
    };
    return icons[iconName] || icons.sparkles;
  };

  // --- RENDER ---
  
  // 1. TASBIH OVERLAY MODE
  if (activeTasbih) {
    const currentTask = tasks.find(t => t.id === activeTasbih.id);
    const progress = (currentTask.count / currentTask.target) * 100;
    
    return (
      <div 
        className="fixed inset-0 bg-emerald-900 z-50 flex flex-col items-center justify-between py-12 px-6 text-white cursor-pointer select-none touch-manipulation"
        onClick={handleTasbihTap}
      >
        <button 
          onClick={(e) => { e.stopPropagation(); setActiveTasbih(null); }}
          className="absolute top-6 right-6 p-2 bg-emerald-800 rounded-full text-emerald-200"
        >
          <X size={24} />
        </button>

        <div className="text-center mt-10">
          <h2 className="text-xl opacity-80 font-medium tracking-wide">Sedang Berzikir</h2>
          <h1 className="text-3xl font-bold mt-2">{currentTask.title}</h1>
        </div>

        <div className="relative w-64 h-64 flex items-center justify-center">
          {/* Circular Progress Effect */}
          <svg className="absolute w-full h-full transform -rotate-90">
             <circle cx="128" cy="128" r="120" stroke="currentColor" strokeWidth="8" fill="transparent" className="text-emerald-800" />
             <circle cx="128" cy="128" r="120" stroke="currentColor" strokeWidth="8" fill="transparent" className="text-emerald-400 transition-all duration-300" strokeDasharray={2 * Math.PI * 120} strokeDashoffset={2 * Math.PI * 120 * (1 - progress / 100)} />
          </svg>
          <div className="text-8xl font-mono font-bold">{currentTask.count}</div>
        </div>

        <div className="text-center mb-10 opacity-70">
          <p>Tap skrin untuk kira</p>
          <p className="text-sm mt-2">Target: {currentTask.target}</p>
        </div>
      </div>
    );
  }

  // 2. MAIN APP
  const completedCount = tasks.filter(t => t.count >= t.target).length;
  const totalTasks = tasks.length;
  const overallProgress = (completedCount / totalTasks) * 100;

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-20">
      {/* HEADER */}
      <div className="bg-emerald-600 text-white p-6 pb-12 rounded-b-[2.5rem] shadow-lg relative overflow-hidden">
        <div className="absolute top-0 right-0 w-32 h-32 bg-white opacity-5 rounded-full -mr-10 -mt-10"></div>
        <div className="flex justify-between items-start mb-4">
          <div>
            <h1 className="text-2xl font-bold font-serif tracking-wide">Nurani</h1>
            <p className="text-emerald-100 text-sm opacity-90">{new Date().toLocaleDateString('ms-MY', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
          </div>
          <button onClick={() => setView(view === 'stats' ? 'home' : 'stats')} className="p-2 bg-emerald-500 rounded-xl hover:bg-emerald-400 transition">
             {view === 'stats' ? <X size={20}/> : <BarChart2 size={20} />}
          </button>
        </div>
        
        {/* PROGRESS CARD */}
        <div className="bg-emerald-700/50 p-4 rounded-2xl border border-emerald-500/30 backdrop-blur-sm flex items-center gap-4">
          <div className="relative w-16 h-16 flex-shrink-0">
             <svg className="w-full h-full transform -rotate-90">
               <circle cx="32" cy="32" r="28" stroke="currentColor" strokeWidth="4" fill="transparent" className="text-emerald-800/50" />
               <circle cx="32" cy="32" r="28" stroke="currentColor" strokeWidth="4" fill="transparent" className="text-yellow-400 transition-all duration-500" strokeDasharray={2 * Math.PI * 28} strokeDashoffset={2 * Math.PI * 28 * (1 - overallProgress / 100)} />
             </svg>
             <div className="absolute inset-0 flex items-center justify-center font-bold text-sm">
               {Math.round(overallProgress)}%
             </div>
          </div>
          <div>
            <p className="text-sm text-emerald-100 font-medium">Pencapaian Hari Ini</p>
            <p className="text-xs opacity-70 mt-1">{completedCount} daripada {totalTasks} amalan selesai.</p>
          </div>
        </div>
      </div>

      {/* AI MOTIVATION */}
      <div className="px-6 -mt-6 mb-4">
        <div className="bg-white p-4 rounded-2xl shadow-sm border border-emerald-100 flex gap-3 items-start relative overflow-hidden">
           <div className="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-yellow-400 to-orange-400"></div>
           <Sparkles className="text-yellow-500 flex-shrink-0 mt-1" size={18} />
           <div className="flex-1">
             <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Pesanan Nurani</p>
             {isAiLoading ? (
               <p className="text-sm text-slate-400 animate-pulse">Sedang mencari kata hikmah...</p>
             ) : (
               <p className="text-sm text-slate-700 italic leading-relaxed">"{aiMotivation || "Mulakan hari dengan Bismillah. Istiqomah kunci kejayaan."}"</p>
             )}
           </div>
           <button onClick={() => generateAiAdvice(tasks)} className="text-slate-300 hover:text-emerald-600">
             <RefreshCcw size={14} />
           </button>
        </div>
      </div>

      {/* MAIN CONTENT AREA */}
      <div className="px-5 space-y-4">
        
        {view === 'stats' ? (
          <div className="space-y-4 animate-in fade-in slide-in-from-bottom-4">
            <h2 className="font-bold text-lg text-slate-700">Analisis Istiqomah</h2>
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
              <div className="flex items-end justify-between h-40 gap-2">
                {history.length === 0 && <div className="w-full h-full flex items-center justify-center text-slate-400 text-sm">Belum ada data sejarah.</div>}
                {[...history].reverse().slice(-7).map((log, idx) => (
                  <div key={idx} className="flex flex-col items-center gap-2 flex-1 group">
                    <div className="relative w-full flex items-end justify-center h-full">
                      <div 
                        className="w-full bg-emerald-200 rounded-t-md group-hover:bg-emerald-400 transition-all"
                        style={{ height: `${log.rate * 100}%` }}
                      ></div>
                    </div>
                    <span className="text-[10px] text-slate-400">{new Date(log.date).getDate()}/{new Date(log.date).getMonth()+1}</span>
                  </div>
                ))}
              </div>
            </div>
            <div className="bg-emerald-50 p-4 rounded-xl text-sm text-emerald-800 border border-emerald-100">
              <p>ðŸ’¡ <b>Tip:</b> Cuba kekalkan bar hijau penuh selama 7 hari berturut-turut untuk membina tabiat yang kukuh.</p>
            </div>
          </div>
        ) : (
          <div className="space-y-3 pb-24">
            {tasks.map((task) => {
              const isComplete = task.count >= task.target;
              return (
                <div 
                  key={task.id} 
                  onClick={() => handleTaskClick(task)}
                  className={`bg-white p-4 rounded-2xl border transition-all duration-300 shadow-sm active:scale-[0.98] cursor-pointer flex items-center justify-between group ${isComplete ? 'border-emerald-200 bg-emerald-50/50' : 'border-slate-100 hover:border-emerald-200'}`}
                >
                  <div className="flex items-center gap-4">
                    <div className={`w-12 h-12 rounded-full flex items-center justify-center transition-colors ${isComplete ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-400 group-hover:bg-emerald-50 group-hover:text-emerald-500'}`}>
                      {getIcon(task.icon, "w-6 h-6")}
                    </div>
                    <div>
                      <h3 className={`font-semibold ${isComplete ? 'text-emerald-800' : 'text-slate-700'}`}>{task.title}</h3>
                      <p className="text-xs text-slate-400">
                        {task.target > 1 ? `Target: ${task.target}x` : 'Harian'}
                      </p>
                    </div>
                  </div>

                  <div className="flex items-center gap-3">
                    {task.target > 1 ? (
                       <div className="text-right">
                         <span className={`text-lg font-bold font-mono ${isComplete ? 'text-emerald-600' : 'text-slate-600'}`}>
                           {task.count}
                         </span>
                         <span className="text-xs text-slate-400">/{task.target}</span>
                       </div>
                    ) : (
                      <div className={`w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${isComplete ? 'bg-emerald-500 border-emerald-500' : 'border-slate-200'}`}>
                        {isComplete && <CheckCircle size={16} className="text-white" />}
                      </div>
                    )}
                    <button onClick={(e) => {e.stopPropagation(); deleteTask(task.id);}} className="p-2 text-slate-300 hover:text-red-400">
                       <Trash2 size={16} />
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>

      {/* FLOATING ADD BUTTON */}
      <button 
        onClick={() => setShowAddModal(true)}
        className="fixed bottom-6 right-6 w-14 h-14 bg-emerald-600 text-white rounded-full shadow-lg shadow-emerald-600/30 flex items-center justify-center hover:bg-emerald-700 transition-transform hover:scale-105 active:scale-95"
      >
        <Plus size={28} />
      </button>

      {/* ADD MODAL */}
      {showAddModal && (
        <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-sm p-4">
          <div className="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-in slide-in-from-bottom-10">
            <h3 className="text-xl font-bold text-slate-800 mb-4">Tambah Amalan Baru</h3>
            
            <div className="space-y-4">
              <div>
                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Amalan</label>
                <input 
                  type="text" 
                  value={newTaskName}
                  onChange={(e) => setNewTaskName(e.target.value)}
                  placeholder="Contoh: Baca Al-Quran (Halaman)"
                  className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                />
              </div>
              
              <div>
                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Sasaran Harian (Jumlah)</label>
                <input 
                  type="number" 
                  value={newTaskTarget}
                  onChange={(e) => setNewTaskTarget(e.target.value)}
                  className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                />
                <p className="text-[10px] text-slate-400 mt-1">*Masukkan '1' untuk sekadar tick box (contoh: Solat).</p>
              </div>

              <div className="flex gap-3 pt-2">
                <button 
                  onClick={() => setShowAddModal(false)}
                  className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-semibold"
                >
                  Batal
                </button>
                <button 
                  onClick={addNewTask}
                  className="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-semibold shadow-lg shadow-emerald-200"
                >
                  Simpan
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

    </div>
  );
}
